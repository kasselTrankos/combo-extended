<html>
  <template id="prettySearchTemplate">
    <style>
      @import "https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-beta.35/css/uikit.min.css";
      .list {
        /*margin: 0 2px;*/
        height: 10rem;
        overflow-y: scroll;
        margin-top: -20px;
      }
      .hide{
        display: none;
      }
      h1{
        color: blue;
        font-size: 44px;
      }
    </style>
    <content>
      <form class="uk-form-stacked">
        <div class="uk-margin">
             <label class="uk-form-label" for="form-stacked-text">Text</label>
             <div class="uk-form-controls">
                 <input class="uk-input" id="form-stacked-text" type="text" placeholder="Some text..." />
             </div>
         </div>
      </form>
      <div class="list hide"><slot name="mioo"></slot></div>
    </content>
  </template>
  <script>
    var _current = document.currentScript.ownerDocument;
    var list = function (el) {
      return {
        addClass: function(name) {
          el.classList.remove(name);
        },
        exists: function (elm) {
          return elm || false;
        }
      }
    };
    var ul = function (cont) {
      this._position = 0;
      return {
        position: function (position){
          this._position = position || 0;
        },
        exists: function (position) {
          position = position || this._position;
          return cont[position] || false;
        },
        addClass: function (name){
          cont[this._position].classList.add(name);
        },
        removeClass: function(name){
          cont[this._position].classList.remove(name);
        }
      }
    } 
    var keyboard = function (data) {
      var hasNext = function (current, total){
        return current < (total || data.length);
      };
      var hasPrev = function(current, minium) {
        return current > minium;
      };
      return {
        iterate: function(from, callback) {
          from = from || 0;
          while (hasNext(from)) {
            callback.call(this, from);
            from ++;
          }
        },
        next:  function(current) {
          if(hasNext(current, data.length - 1)) return ++current;
          return data.length -1;
        },
        prev: function(current){
          if(hasPrev(current, 0)) return --current;
          return 0;
        }
      };
    };
    
    class nameBadge extends HTMLElement {
      constructor() {
        super();
      }
      load(url) {
        var req = new XMLHttpRequest();
        req.open('GET', url);
        req.responseType = 'json';
        req.send();
        req.onload = function(response, dat) {
          if(req.status == 200){
            this.data = req.response;
            this.fill()
          } else {
            // something went wrong
          }
        }.bind(this)
      }
      fill() {
        for(var i=0; i< this.data.length; i++) {
          var LI = document.createElement('LI');
          LI.innerHTML = this.data[i].name;
          this.getElementsByTagName('UL')[0].appendChild(LI);
        }

      }
      handle(e) {
        
        if(Array.prototype.slice.call(this.shadow.querySelectorAll('.list')[0].classList).indexOf('hide')<0)
        {
          var move = keyboard(this.getElementsByTagName('LI'));
          var _list = list(this.shadow.querySelectorAll('.list')[0]);
          var _ul = ul(this.getElementsByTagName('LI'));
          move.iterate(0, function(i) {
            _ul.position(i);
            _ul.removeClass('active');
          }.bind(this))
          if (e.keyCode === 40) this.position = move.next(this.position);
          if (e.keyCode === 38) this.position = move.prev(this.position);
          _ul.position(this.position);
          if (_ul.exists()) _ul.addClass('active');
          if (e.keyCode === 13) {
            e.preventDefault();
            e.stopPropagation();
            e.target.value = this.getElementsByTagName('LI')[this.position] ? this.getElementsByTagName('LI')[this.position].innerHTML  : '';
            _list.add("hide");  
          }
        }
      }
      connectedCallback() {
        this.position = -1;
        this.importDoc = _current.querySelectorAll('template')[0];//_current.getElementById('prettySearchTemplate')
        this.shadow = this.attachShadow({ mode: "open" });
        this.load(this.getAttribute('data-load'));
        //importDoc.content.lastElementChild.getElementsByTagName('content')[0].innerText = this.lastChild.data;
        this.shadow.appendChild(this.importDoc.content.cloneNode(true));
        var kinput = this.shadow.lastElementChild.getElementsByTagName('INPUT')[0]
        kinput.addEventListener('input', function(e) {
          if(e.target.value.length>0) this.shadow.querySelectorAll('.list')[0].classList.remove("hide");
          else this.shadow.querySelectorAll('.list')[0].classList.add("hide");
        }.bind(this));
        kinput.onkeydown = this.handle.bind(this);
      }
    }
    customElements.define("pretty-search", nameBadge);
  </script>
</html>
